import { Logger } from './logger.js';
export * from './releaser.types.js';
/**
 * A releaser class that provides methods to manage the release process of a project.
 */
export class Releaser {
    options;
    /**
     * Target project to release.
     */
    project;
    /**
     * Git repository hosting service to use for creating releases and pull requests.
     */
    hosting;
    /**
     * The git client used to interact with the repository.
     */
    gitClient;
    /**
     * The logger used to log messages during the release process.
     */
    logger;
    state = {};
    stepsOptions = {};
    queue = [];
    /**
     * Creates a project releaser.
     * @param options
     */
    constructor(options) {
        this.options = options;
        const { project, hosting } = options;
        this.project = project;
        this.hosting = hosting;
        this.gitClient = project.gitClient;
        this.logger = options.logger ?? new Logger(options);
    }
    enqueue(fn) {
        this.queue.push(fn);
        return this;
    }
    async getBaseBranch() {
        const { baseBranch } = this.state;
        if (baseBranch) {
            return baseBranch;
        }
        return await this.project.gitClient.getCurrentBranch();
    }
    /**
     * Set default options for the releaser steps.
     * @param options
     * @returns Project releaser instance for chaining.
     */
    setOptions(options) {
        const { logger } = this;
        logger.verbose('set-options', 'Setting options for steps:');
        logger.verbose('set-options', options);
        for (const [key, value] of Object.entries(options)) {
            Object.assign(this.stepsOptions[key] ??= {}, value);
        }
        logger.verbose('set-options', 'Final options for steps:');
        logger.verbose('set-options', this.stepsOptions);
        return this;
    }
    /**
     * Enqueue a task to checkout a branch.
     * @param branch - The branch to checkout, defaults to `'simple-release'`.
     * @param options
     * @returns Project releaser instance for chaining.
     */
    checkout(branch, options = {}) {
        return this.enqueue(async () => {
            const { logger, gitClient } = this;
            const { dryRun } = this.options;
            const { branch: headBranch = 'simple-release', username, email, fetch, force } = {
                ...this.stepsOptions.checkout,
                ...options,
                ...branch
                    ? {
                        branch
                    }
                    : {}
            };
            logger.info('checkout', `Checking out branch ${headBranch}...`);
            this.state.headBranch = headBranch;
            this.state.baseBranch = await this.getBaseBranch();
            if (username) {
                logger.verbose('checkout', `Setting git user.name to "${username}".`);
                if (!dryRun) {
                    await gitClient.setConfig('user.name', username);
                }
            }
            if (email) {
                logger.verbose('checkout', `Setting git user.email to "${email}".`);
                if (!dryRun) {
                    await gitClient.setConfig('user.email', email);
                }
            }
            if (fetch) {
                logger.verbose('checkout', `Fetching all commits and tags from the remote repository...`);
                if (!dryRun) {
                    await gitClient.fetch({
                        prune: true,
                        unshallow: true,
                        tags: true,
                        remote: 'origin',
                        branch: 'HEAD'
                    });
                }
            }
            if (force) {
                logger.verbose('checkout', `Deleting branch ${headBranch} if it exists...`);
                if (!dryRun) {
                    await gitClient.deleteBranch(headBranch).catch(() => null);
                }
            }
            try {
                logger.verbose('checkout', `Creating branch ${headBranch}...`);
                if (!dryRun) {
                    await gitClient.createBranch(headBranch);
                }
            }
            catch {
                logger.verbose('checkout', `Branch ${headBranch} already exists, checking it out...`);
                if (!dryRun) {
                    await gitClient.checkout(headBranch);
                }
            }
        });
    }
    /**
     * Enqueue a task to bump the version of the project.
     * @param options
     * @returns Project releaser instance for chaining.
     */
    bump(options) {
        return this.enqueue(async () => {
            const { project } = this;
            const { dryRun } = this.options;
            const logger = this.logger.createChild('bump');
            logger.info('Bumping version...');
            const done = await project.bump({
                dryRun,
                logger,
                ...this.stepsOptions.bump,
                ...options
            });
            this.state.bump = done;
            if (!done) {
                logger.info('No version changes detected.');
            }
        });
    }
    /**
     * Enqueue a task to commit bump changes to the repository.
     * @param options
     * @returns Project releaser instance for chaining.
     */
    commit(options) {
        return this.enqueue(async () => {
            const { project, logger, gitClient } = this;
            const { dryRun } = this.options;
            logger.info('commit', `Committing changes...`);
            if (!this.state.bump) {
                logger.info('commit', 'No changes to commit.');
                return;
            }
            const files = project.changedFiles;
            const params = {
                ...this.stepsOptions.commit,
                ...options,
                message: project.getCommitMessage(),
                verify: false
            };
            logger.verbose('commit', `Files to commit:`);
            files.forEach((file) => {
                logger.verbose('commit', `- ${file}`);
            });
            logger.verbose('commit', params.message.includes('\n')
                ? `Commit message:\n\n${params.message}\n`
                : `Commit message: ${params.message}`);
            if (!dryRun) {
                await gitClient.add(files);
                await gitClient.commit(params);
            }
        });
    }
    /**
     * Enqueue a task to tag the project with the new version.
     * @param options
     * @returns Project releaser instance for chaining.
     */
    tag(options) {
        return this.enqueue(async () => {
            const { project, logger, gitClient } = this;
            const { dryRun } = this.options;
            const { fetch, ...tagOptions } = {
                ...this.stepsOptions.tag,
                ...options
            };
            logger.info('tag', 'Tagging version...');
            if (fetch) {
                logger.verbose('tag', 'Fetching fresh tags from the remote repository...');
                if (!dryRun) {
                    await gitClient.fetch({
                        tags: true
                    });
                }
            }
            const tags = await project.getTags();
            this.state.tags = tags.length > 0;
            if (!this.state.tags) {
                logger.info('tag', 'No version changes detected.');
                return;
            }
            logger.verbose('tag', `Tags to create:`);
            for (const tag of tags) {
                logger.verbose('tag', `- ${tag}`);
                if (!dryRun) {
                    await gitClient.tag({
                        ...tagOptions,
                        name: tag
                    });
                }
            }
        });
    }
    /**
     * Enqueue a task to push changes to the remote repository.
     * @param options
     * @returns Project releaser instance for chaining.
     */
    push(options) {
        return this.enqueue(async () => {
            const { logger, gitClient, state } = this;
            const { dryRun } = this.options;
            const branch = await gitClient.getCurrentBranch();
            logger.info('push', `Pushing changes to ${branch}...`);
            if (!state.bump && !state.tags) {
                logger.info('push', 'Nothing to push.');
                return;
            }
            if (!dryRun) {
                if (state.bump) {
                    await gitClient.push(branch, {
                        verify: false,
                        ...this.stepsOptions.push,
                        ...options
                    });
                }
                if (state.tags) {
                    await gitClient.push(branch, {
                        tags: true,
                        verify: false
                    });
                }
            }
        });
    }
    /**
     * Enqueue a task to publish the project.
     * @param options
     * @returns Project releaser instance for chaining.
     */
    publish(options) {
        return this.enqueue(async () => {
            const { project } = this;
            const { dryRun } = this.options;
            const logger = this.logger.createChild('package');
            const publishOptions = {
                dryRun,
                logger,
                ...this.stepsOptions.publish,
                ...options
            };
            if (publishOptions.skip) {
                logger.verbose('Skipping publish');
                return;
            }
            logger.info('Publishing...');
            await project.publish(publishOptions);
        });
    }
    /**
     * Enqueue a task to create a release.
     * @param option
     * @returns Project releaser instance for chaining.
     */
    release(option) {
        const { hosting } = this;
        if (!hosting) {
            throw new Error('Hosting service is not configured. Please set the hosting option.');
        }
        return this.enqueue(async () => {
            const { project } = this;
            const { dryRun } = this.options;
            const logger = this.logger.createChild('release');
            logger.info('Creating release...');
            await hosting.createRelease({
                project,
                dryRun,
                logger,
                ...this.stepsOptions.release,
                ...option
            });
        });
    }
    /**
     * Enqueue a task to create a pull request.
     * @param option
     * @returns Project releaser instance for chaining.
     */
    pullRequest(option) {
        const { hosting } = this;
        if (!hosting) {
            throw new Error('Hosting service is not configured. Please set the hosting option.');
        }
        return this.enqueue(async () => {
            const { project, state } = this;
            const { dryRun } = this.options;
            const logger = this.logger.createChild('pull-request');
            logger.info('Creating pull request...');
            if (!state.bump) {
                logger.info('No version changes detected, skipping pull request creation.');
                return;
            }
            if (!state.headBranch) {
                logger.info('Head branch is not set, skipping pull request creation.');
                return;
            }
            await hosting.createPullRequest({
                project,
                dryRun,
                logger,
                from: state.headBranch,
                to: await this.getBaseBranch(),
                ...this.stepsOptions.pullRequest,
                ...option
            });
        });
    }
    /**
     * Run all queued tasks in order.
     * @param condition - Optional condition to run the releaser.
     */
    async run(condition) {
        let shouldRun = true;
        if (condition) {
            const { logger } = this;
            logger.info('run', 'Checking condition...');
            shouldRun = await condition(this);
            if (shouldRun) {
                logger.info('run', 'Condition passed, running releas steps...');
            }
            else {
                logger.info('run', 'Condition failed, skipping release steps.');
            }
        }
        if (shouldRun) {
            for (const fn of this.queue) {
                await fn();
            }
        }
        this.queue.length = 0;
        this.logger.info('done', `Done!`);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVsZWFzZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvcmVsZWFzZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBR0EsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLGFBQWEsQ0FBQTtBQVdwQyxjQUFjLHFCQUFxQixDQUFBO0FBRW5DOztHQUVHO0FBQ0gsTUFBTSxPQUFPLFFBQVE7SUFvQ1Y7SUFoQ1Q7O09BRUc7SUFDTSxPQUFPLENBQUc7SUFDbkI7O09BRUc7SUFDTSxPQUFPLENBQUk7SUFDcEI7O09BRUc7SUFDTSxTQUFTLENBQXVCO0lBQ3pDOztPQUVHO0lBQ00sTUFBTSxDQUFRO0lBQ0osS0FBSyxHQUtwQixFQUFFLENBQUE7SUFFYSxZQUFZLEdBQStCLEVBQUUsQ0FBQTtJQUUvQyxLQUFLLEdBQStCLEVBQUUsQ0FBQTtJQUV2RDs7O09BR0c7SUFDSCxZQUNTLE9BQThCO1FBQTlCLFlBQU8sR0FBUCxPQUFPLENBQXVCO1FBRXJDLE1BQU0sRUFDSixPQUFPLEVBQ1AsT0FBTyxFQUNSLEdBQUcsT0FBTyxDQUFBO1FBRVgsSUFBSSxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUE7UUFDdEIsSUFBSSxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUE7UUFDdEIsSUFBSSxDQUFDLFNBQVMsR0FBRyxPQUFPLENBQUMsU0FBUyxDQUFBO1FBQ2xDLElBQUksQ0FBQyxNQUFNLEdBQUcsT0FBTyxDQUFDLE1BQU0sSUFBSSxJQUFJLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQTtJQUNyRCxDQUFDO0lBRUQsT0FBTyxDQUFDLEVBQXVCO1FBQzdCLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFBO1FBQ25CLE9BQU8sSUFBSSxDQUFBO0lBQ2IsQ0FBQztJQUVPLEtBQUssQ0FBQyxhQUFhO1FBQ3pCLE1BQU0sRUFBRSxVQUFVLEVBQUUsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFBO1FBRWpDLElBQUksVUFBVSxFQUFF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