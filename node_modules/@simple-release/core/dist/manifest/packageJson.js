import fs from 'fs/promises';
import { ProjectManifest } from './manifest.js';
export * from './packageJson.types.js';
/**
 * A class that represents a package.json manifest.
 */
export class PackageJsonManifest extends ProjectManifest {
    static Filename = 'package.json';
    contents;
    manifest;
    contentsMutex;
    async readManifest() {
        if (!this.contentsMutex) {
            this.contentsMutex = fs.readFile(this.manifestPath, 'utf-8');
            this.contents = await this.contentsMutex;
            this.manifest = JSON.parse(this.contents);
            return this.manifest;
        }
        await this.contentsMutex;
        return this.manifest;
    }
    async getName() {
        const manifest = await this.readManifest();
        return manifest.name;
    }
    async getVersion() {
        const manifest = await this.readManifest();
        return manifest.version;
    }
    async isPrivate() {
        const manifest = await this.readManifest();
        return Boolean(manifest.private);
    }
    async writeVersion(version, dryRun) {
        await this.readManifest();
        const { name, version: from } = this.manifest;
        this.manifest.version = version;
        this.contents = this.contents.replace(/"version":(\s*)"[^"]+"/, `"version":$1"${version}"`);
        if (!dryRun) {
            await fs.writeFile(this.manifestPath, this.contents, 'utf-8');
        }
        return {
            name,
            from,
            to: version,
            files: [this.manifestPath]
        };
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFja2FnZUpzb24uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvbWFuaWZlc3QvcGFja2FnZUpzb24udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLE1BQU0sYUFBYSxDQUFBO0FBQzVCLE9BQU8sRUFFTCxlQUFlLEVBQ2hCLE1BQU0sZUFBZSxDQUFBO0FBR3RCLGNBQWMsd0JBQXdCLENBQUE7QUFFdEM7O0dBRUc7QUFDSCxNQUFNLE9BQU8sbUJBQW9CLFNBQVEsZUFBaUM7SUFDeEUsTUFBTSxDQUFVLFFBQVEsR0FBRyxjQUFjLENBQUE7SUFFekMsUUFBUSxDQUFvQjtJQUM1QixRQUFRLENBQThCO0lBQzlCLGFBQWEsQ0FBNkI7SUFFbEQsS0FBSyxDQUFDLFlBQVk7UUFDaEIsSUFBSSxDQUFDLElBQUksQ0FBQyxhQUFhLEVBQUU7WUFDdkIsSUFBSSxDQUFDLGFBQWEsR0FBRyxFQUFFLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxZQUFZLEVBQUUsT0FBTyxDQUFDLENBQUE7WUFDNUQsSUFBSSxDQUFDLFFBQVEsR0FBRyxNQUFNLElBQUksQ0FBQyxhQUFhLENBQUE7WUFDeEMsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQXFCLENBQUE7WUFFN0QsT0FBTyxJQUFJLENBQUMsUUFBUSxDQUFBO1NBQ3JCO1FBRUQsTUFBTSxJQUFJLENBQUMsYUFBYSxDQUFBO1FBRXhCLE9BQU8sSUFBSSxDQUFDLFFBQVMsQ0FBQTtJQUN2QixDQUFDO0lBRUQsS0FBSyxDQUFDLE9BQU87UUFDWCxNQUFNLFFBQVEsR0FBRyxNQUFNLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQTtRQUUxQyxPQUFPLFFBQVEsQ0FBQyxJQUFJLENBQUE7SUFDdEIsQ0FBQztJQUVELEtBQUssQ0FBQyxVQUFVO1FBQ2QsTUFBTSxRQUFRLEdBQUcsTUFBTSxJQUFJLENBQUMsWUFBWSxFQUFFLENBQUE7UUFFMUMsT0FBTyxRQUFRLENBQUMsT0FBTyxDQUFBO0lBQ3pCLENBQUM7SUFFRCxLQUFLLENBQUMsU0FBUztRQUNiLE1BQU0sUUFBUSxHQUFHLE1BQU0sSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFBO1FBRTFDLE9BQU8sT0FBTyxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQTtJQUNsQyxDQUFDO0lBRUQsS0FBSyxDQUFDLFlBQVksQ0FBQyxPQUFlLEVBQUUsTUFBZ0I7UUFDbEQsTUFBTSxJQUFJLENBQUMsWUFBWSxFQUFFLENBQUE7UUFFekIsTUFBTSxFQUNKLElBQUksRUFDSixPQUFPLEVBQUUsSUFBSSxFQUNkLEdBQUcsSUFBSSxDQUFDLFFBQVMsQ0FBQTtRQUVsQixJQUFJLENBQUMsUUFBUyxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUE7UUFDaEMsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUMsUUFBUyxDQUFDLE9BQU8sQ0FDcEMsd0JBQXdCLEVBQ3hCLGdCQUFnQixPQUFPLEdBQUcsQ0FDM0IsQ0FBQTtRQUVELElBQUksQ0FBQyxNQUFNLEVBQUU7WUFDWCxNQUFNLEVBQUUsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRSxJQUFJLENBQUMsUUFBUSxFQUFFLE9BQU8sQ0FBQyxDQUFBO1NBQzlEO1FBRUQsT0FBTztZQUNMLElBQUk7WUFDSixJQUFJO1lBQ0osRUFBRSxFQUFFLE9BQU87WUFDWCxLQUFLLEVBQUUsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDO1NBQzNCLENBQUE7SUFDSCxDQUFDIn0=