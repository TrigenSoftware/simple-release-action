/* eslint-disable no-labels */
import { createReadStream, createWriteStream } from 'fs';
import fs from 'fs/promises';
import { tmpfile, isFileExists } from './utils.js';
const versionHeaderRegex = /^#+ \[?([^[\]()\s]*\d+\.\d+\.\d+[^[\]()\s]*)\]?/m;
const tagsRegex = /\/([^/)]*)\.\.\.([^/)]*)\)/;
export const changelogHeader = `# Changelog

All notable changes to this project will be documented in this file.
See [Conventional Commits](https://conventionalcommits.org) for commit guidelines.

`;
/**
 * Add release notes to a changelog file.
 * @param changelogPath - The path to the changelog file.
 * @param notes - An async iterable of strings representing the release notes.
 * @returns The release notes that were added to the changelog.
 */
export async function addReleaseNotes(changelogPath, notes) {
    const tmpChangelogPath = tmpfile('changelog');
    const isNewFile = !await isFileExists(changelogPath);
    const output = createWriteStream(tmpChangelogPath);
    let changes = '';
    if (isNewFile) {
        output.write(changelogHeader);
        for await (const chunk of notes) {
            output.write(chunk);
            changes += chunk;
        }
    }
    else {
        const input = createReadStream(changelogPath);
        let isHeader = true;
        let chunk;
        for await (chunk of input) {
            chunk = chunk.toString();
            if (isHeader) {
                const headerIndex = chunk.search(versionHeaderRegex);
                if (headerIndex !== -1) {
                    isHeader = false;
                    output.write(chunk.slice(0, headerIndex));
                    chunk = chunk.slice(headerIndex);
                    for await (const chunk of notes) {
                        output.write(chunk);
                        changes += chunk;
                    }
                    output.write('\n');
                }
            }
            output.write(chunk);
        }
        await fs.rm(changelogPath);
    }
    await new Promise(output.end.bind(output));
    await fs.rename(tmpChangelogPath, changelogPath);
    return changes;
}
/**
 * Extract the last release notes from a stream.
 * @param input
 * @returns An object containing the release notes, previous tag, and next tag.
 */
export async function extractLastRelease(input) {
    let stream = input;
    let inLastChanges = false;
    let notes = '';
    let chunk;
    let lines;
    let line;
    let previousTag = '';
    let nextTag = '';
    let version = '';
    if (typeof stream === 'string') {
        stream = [stream];
    }
    top: for await (chunk of stream) {
        lines = chunk.toString('utf8').split(/\n/);
        for (line of lines) {
            const versionMatch = line.match(versionHeaderRegex);
            if (versionMatch) {
                if (inLastChanges) {
                    break top;
                }
                [, version] = versionMatch;
                inLastChanges = true;
                const tagsMatch = line.match(tagsRegex);
                if (tagsMatch) {
                    [
                        ,
                        previousTag,
                        nextTag
                    ] = tagsMatch;
                }
                continue;
            }
            if (inLastChanges) {
                notes += `${line}\n`;
            }
        }
    }
    return {
        version,
        notes: notes.trim(),
        previousTag,
        nextTag
    };
}
/**
 * Extract the last release notes from a changelog file.
 * @param changelogPath - The path to the changelog file.
 * @returns An object containing the release notes, previous tag, and next tag.
 */
export async function extractLastReleaseFromFile(changelogPath) {
    if (!await isFileExists(changelogPath)) {
        return null;
    }
    const input = createReadStream(changelogPath);
    return await extractLastRelease(input);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2hhbmdlLWxvZy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9jaGFuZ2UtbG9nLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLDhCQUE4QjtBQUM5QixPQUFPLEVBQ0wsZ0JBQWdCLEVBQ2hCLGlCQUFpQixFQUNsQixNQUFNLElBQUksQ0FBQTtBQUNYLE9BQU8sRUFBRSxNQUFNLGFBQWEsQ0FBQTtBQUM1QixPQUFPLEVBQ0wsT0FBTyxFQUNQLFlBQVksRUFDYixNQUFNLFlBQVksQ0FBQTtBQUVuQixNQUFNLGtCQUFrQixHQUFHLGtEQUFrRCxDQUFBO0FBQzdFLE1BQU0sU0FBUyxHQUFHLDRCQUE0QixDQUFBO0FBRTlDLE1BQU0sQ0FBQyxNQUFNLGVBQWUsR0FBRzs7Ozs7Q0FLOUIsQ0FBQTtBQUVEOzs7OztHQUtHO0FBQ0gsTUFBTSxDQUFDLEtBQUssVUFBVSxlQUFlLENBQ25DLGFBQXFCLEVBQ3JCLEtBQTRCO0lBRTVCLE1BQU0sZ0JBQWdCLEdBQUcsT0FBTyxDQUFDLFdBQVcsQ0FBQyxDQUFBO0lBQzdDLE1BQU0sU0FBUyxHQUFHLENBQUMsTUFBTSxZQUFZLENBQUMsYUFBYSxDQUFDLENBQUE7SUFDcEQsTUFBTSxNQUFNLEdBQUcsaUJBQWlCLENBQUMsZ0JBQWdCLENBQUMsQ0FBQTtJQUNsRCxJQUFJLE9BQU8sR0FBRyxFQUFFLENBQUE7SUFFaEIsSUFBSSxTQUFTLEVBQUU7UUFDYixNQUFNLENBQUMsS0FBSyxDQUFDLGVBQWUsQ0FBQyxDQUFBO1FBRTdCLElBQUksS0FBSyxFQUFFLE1BQU0sS0FBSyxJQUFJLEtBQUssRUFBRTtZQUMvQixNQUFNLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFBO1lBQ25CLE9BQU8sSUFBSSxLQUFLLENBQUE7U0FDakI7S0FDRjtTQUFNO1FBQ0wsTUFBTSxLQUFLLEdBQUcsZ0JBQWdCLENBQUMsYUFBYSxDQUFDLENBQUE7UUFDN0MsSUFBSSxRQUFRLEdBQUcsSUFBSSxDQUFBO1FBQ25C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