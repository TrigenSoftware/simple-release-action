import fs from 'fs/promises';
import { ProjectManifest } from './manifest.js';
export * from './packageJson.types.js';
/**
 * A class that represents a package.json manifest.
 */
export class PackageJsonManifest extends ProjectManifest {
    static Filename = 'package.json';
    contents;
    manifest;
    contentsMutex;
    async readManifest() {
        if (!this.contentsMutex) {
            this.contentsMutex = fs.readFile(this.manifestPath, 'utf-8');
            this.contents = await this.contentsMutex;
            this.manifest = JSON.parse(this.contents);
            return this.manifest;
        }
        await this.contentsMutex;
        return this.manifest;
    }
    async getName() {
        const manifest = await this.readManifest();
        return manifest.name;
    }
    async getVersion() {
        const manifest = await this.readManifest();
        return manifest.version;
    }
    async isPrivate() {
        const manifest = await this.readManifest();
        return Boolean(manifest.private);
    }
    async writeVersion(version, dryRun) {
        await this.readManifest();
        const { name, version: from } = this.manifest;
        this.manifest.version = version;
        this.contents = this.contents.replace(/"version":(\s*)"[^"]+"/, `"version":$1"${version}"`);
        if (!dryRun) {
            await fs.writeFile(this.manifestPath, this.contents, 'utf-8');
        }
        return {
            name,
            from,
            to: version,
            files: [this.manifestPath]
        };
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFja2FnZUpzb24uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvbWFuaWZlc3QvcGFja2FnZUpzb24udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLE1BQU0sYUFBYSxDQUFBO0FBQzVCLE9BQU8sRUFFTCxlQUFlLEVBQ2hCLE1BQU0sZUFBZSxDQUFBO0FBR3RCLGNBQWMsd0JBQXdCLENBQUE7QUFFdEM7O0dBRUc7QUFDSCxNQUFNLE9BQU8sbUJBQW9CLFNBQVEsZUFBaUM7SUFDeEUsTUFBTSxDQUFVLFFBQVEsR0FBRyxjQUFjLENBQUE7SUFFekMsUUFBUSxDQUFvQjtJQUM1QixRQUFRLENBQThCO0lBQzlCLGFBQWEsQ0FBNkI7SUFFbEQsS0FBSyxDQUFDLFlBQVk7UUFDaEIsSUFBSSxDQUFDLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztZQUN4QixJQUFJLENBQUMsYUFBYSxHQUFHLEVBQUUsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRSxPQUFPLENBQUMsQ0FBQTtZQUM1RCxJQUFJLENBQUMsUUFBUSxHQUFHLE1BQU0sSUFBSSxDQUFDLGFBQWEsQ0FBQTtZQUN4QyxJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBcUIsQ0FBQTtZQUU3RCxPQUFPLElBQUksQ0FBQyxRQUFRLENBQUE7UUFDdEIsQ0FBQztRQUVELE1BQU0sSUFBSSxDQUFDLGFBQWEsQ0FBQTtRQUV4QixPQUFPLElBQUksQ0FBQyxRQUFTLENBQUE7SUFDdkIsQ0FBQztJQUVELEtBQUssQ0FBQyxPQUFPO1FBQ1gsTUFBTSxRQUFRLEdBQUcsTUFBTSxJQUFJLENBQUMsWUFBWSxFQUFFLENBQUE7UUFFMUMsT0FBTyxRQUFRLENBQUMsSUFBSSxDQUFBO0lBQ3RCLENBQUM7SUFFRCxLQUFLLENBQUMsVUFBVTtRQUNkLE1BQU0sUUFBUSxHQUFHLE1BQU0sSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFBO1FBRTFDLE9BQU8sUUFBUSxDQUFDLE9BQU8sQ0FBQTtJQUN6QixDQUFDO0lBRUQsS0FBSyxDQUFDLFNBQVM7UUFDYixNQUFNLFFBQVEsR0FBRyxNQUFNLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQTtRQUUxQyxPQUFPLE9BQU8sQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUE7SUFDbEMsQ0FBQztJQUVELEtBQUssQ0FBQyxZQUFZLENBQUMsT0FBZSxFQUFFLE1BQWdCO1FBQ2xELE1BQU0sSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFBO1FBRXpCLE1BQU0sRUFDSixJQUFJLEVBQ0osT0FBTyxFQUFFLElBQUksRUFDZCxHQUFHLElBQUksQ0FBQyxRQUFTLENBQUE7UUFFbEIsSUFBSSxDQUFDLFFBQVMsQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFBO1FBQ2hDLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDLFFBQVMsQ0FBQyxPQUFPLENBQ3BDLHdCQUF3QixFQUN4QixnQkFBZ0IsT0FBTyxHQUFHLENBQzNCLENBQUE7UUFFRCxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7WUFDWixNQUFNLEVBQUUsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRSxJQUFJLENBQUMsUUFBUSxFQUFFLE9BQU8sQ0FBQyxDQUFBO1FBQy9ELENBQUM7UUFFRCxPQUFPO1lBQ0wsSUFBSTtZQUNKLElBQUk7WUFDSixFQUFFLEVBQUUsT0FBTztZQUNYLEtBQUssRUFBRSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUM7U0FDM0IsQ0FBQTtJQUNILENBQUMifQ==